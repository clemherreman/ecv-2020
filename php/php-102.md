# PHP 102

## Objectif

Utilisation plus avancée de PHP :

* Editer la configuration de PHP
* Programmer en divisant le travail à faire en fonctions
* Savoir manipuler des fichiers : lecture, écriture, etc.
* Communiquer avec une base de données
* Afficher une page web permettant d'interagir avec la base de données.

## La configuration de PHP

Comme vu dans le cours de Devops, la configuration de PHP se trouve dans 2 endroits, suivant le contexte d'execution :

* En CLI : dans `/etc/php/7.3/cli/conf.d/*.ini`
* En FPM : dans `/etc/php/7.3/fpm/conf.d/*.ini`

Exemple : on souhaite s'assurer que toutes les erreurs sont bien affichées, dans tous les cas - ce qui est un choix plutôt sain dans 99% des cas.

{% code title="/etc/php/7.3/fpm/conf.d/30-ecv.ini" %}
```text
error_reporting = E_ALL
display_error = On
```
{% endcode %}

{% hint style="info" %}
Je recommande de mettre la même chose en CLI
{% endhint %}

## Manipulation de fichiers

Dans PHP, comme dans beaucoup de langages, les fichiers sont considérés comme des fluxs. On ouvre un fichier, et on obtient un pointeur vers ce fichier.

On peut ensuite effectuer des opérations : lire x kB de données, ecrire une string ou x kB de données dedans.

On ferme ensuite le fichier, pour libérer le pointeur, et indiquer à l'OS que le process n'ouvre plus ce fichier.

### `fopen` - Ouvrir un fichier

```php
<?php

$myFile = fopen('/tmp/myFile.txt');

// Ici on peut utiliser $myFile pour toute les opérations.

fclose($myFile);
```

#### Permissions \(oui, encore, mais pas les mêmes\).

Lorsqu'on ouvre un fichier, on l'ouvre avec différents modes \(voici les principaux\) : 

| Mode | Description |
| :--- | :--- |
| `'r'` | Ouvre en lecture seule, et place le pointeur de fichier au début du fichier. |
| `'r+'` | Ouvre en lecture et écriture, et place le pointeur de fichier au début du fichier. |
| `'a+'` | Ouvre en lecture et écriture ; place le pointeur de fichier à la fin du fichier. _Si le fichier n'existe pas, on tente de le créer.\*_ |
| `'w+'` |  Ouvre en lecture et écriture ; place le pointeur de fichier au début du fichier et réduit la taille du fichier à 0. Si le fichier n'existe pas, on tente de le créer.  |

{% hint style="warning" %}
Note\* : Pour créer le fichier, il faut que l'utilisateur courant ait les droits d'écriture dans le dossier en question... cela dépend donc [**des permissions Linux**](../devops/ecv-2020-devops.md#chmod-et-chown-gerer-les-permissions). Idem pour l'ouverture en lecture.
{% endhint %}

{% hint style="info" %}
L'ensemble des modes possibles, sur la doc de PHP : [https://www.php.net/manual/fr/function.fopen.php](https://www.php.net/manual/fr/function.fopen.php)
{% endhint %}

```php
<?php
$filepath = '/tmp/myFile.txt';
$myFile = fopen($filepath, 'r+');

// ici deux cas :
if ($myFile === false) {
  // Je n'ai pas les permissions suffisantes pour ouvrir
  // ce fichier en lecture et ecriture.
  echo 'Permissions insufisantes pour ouvrir '.$filepath;
  die;
}

// Dans le cas contraire, je peux tranquillement écrire & lire dedans.
```

### `fgets`, `fgetc`, `fread` - Lire dans un fichier

Imaginons le fichier suivant

```bash
$ cat /tmp/sample.txt
This is the file content.
It has multiple sentences
that may run on multiple lines.

It even has empty lines

Like that one before.
```

* `fgets` permet de lire un fichier ligne par ligne

```php
<?php
$sampleFile = fopen('/tmp/sample.txt', 'r');

echo fgets($sampleFile); // Affiche "This is the file content."
echo fgets($sampleFile); // Affiche "It has multiple sentences."
echo fgets($sampleFile); // Affiche "that may run on multiple lines"
echo fgets($sampleFile); // Affiche ""
```

* `fgetc` permet de lire caractère par caractère

```php
<?php
$sampleFile = fopen('/tmp/sample.txt', 'r');

echo fgetc($sampleFile); // Affiche "T"
echo fgetc($sampleFile); // Affiche "h"
echo fgetc($sampleFile); // Affiche "i"
echo fgetc($sampleFile); // Affiche "s"
```

* `fread` permet de lire `n` octets

```php
<?php
$sampleFile = fopen('/tmp/sample.txt', 'r');

echo fread($sampleFile, 4); // Affiche "This"
```

#### Autre fonctions notables

* `file_exists` : permet de savoir si un chemin existe vraiment
* `file_get_contents`: récupère tout le contenu d'un fichier en une fois.

### `fwrite` - Ecrire dans un fichier

```php
<?php
$filepath = '/tmp/sample.txt';
$sampleFile = fopen($filepath, 'a+');

fwrite($sampleFile, 'This will be appended');
fwrite($sampleFile, ', and so will this.');
fclose($sampleFile);
```

{% hint style="info" %}
Vous tomberez parfois sur `fputs` au lieu de `fwrite`. C'est un simple alias de la fonction, parce que... PHP.
{% endhint %}

{% hint style="danger" %}
fwrite n'ajoute pas tout seul un retour à la ligne, il faut le mettre dans la string que vous écrivez.
{% endhint %}



